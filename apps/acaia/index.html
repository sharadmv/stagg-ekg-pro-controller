<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acaia Pearl Web Controller</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #fdfdfd;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }

        .container {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 300px;
        }

        h1 {
            margin-top: 0;
            font-size: 1.2rem;
            color: #666;
        }

        .display {
            margin: 2rem 0;
        }

        .weight {
            font-size: 3.5rem;
            font-weight: 700;
            color: #222;
            font-variant-numeric: tabular-nums;
        }

        .unit {
            font-size: 1rem;
            color: #888;
        }

        .timer {
            font-size: 1.5rem;
            color: #555;
            margin-top: 0.5rem;
            font-family: monospace;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        button {
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
            font-weight: 600;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-connect {
            background: #007aff;
            color: white;
            width: 100%;
            margin-bottom: 20px;
        }

        .btn-connect:hover {
            background: #0060c9;
        }

        .btn-tare {
            background: #ffcc00;
            color: black;
        }

        .btn-timer {
            background: #34c759;
            color: white;
        }

        .btn-stop {
            background: #ff3b30;
            color: white;
        }

        .btn-reset {
            background: #8e8e93;
            color: white;
        }

        .status {
            margin-top: 20px;
            font-size: 0.8rem;
            color: #aaa;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>Acaia Pearl Controller</h1>
        <button id="connectBtn" class="btn-connect">Connect Scale</button>

        <div class="display">
            <div class="weight" id="weightDisplay">0.0</div>
            <div class="unit">g</div>
            <div class="timer" id="timerDisplay">00:00</div>
        </div>

        <div class="controls">
            <button id="tareBtn" class="btn-tare" disabled>TARE</button>
            <button id="timerBtn" class="btn-timer" disabled>START</button>
            <button id="stopBtn" class="btn-stop" disabled>STOP</button>
            <button id="resetBtn" class="btn-reset" disabled>RESET</button>
        </div>

        <div class="status" id="status">Disconnected</div>
        <div id="log"
            style="margin-top:20px; font-family:monospace; font-size:10px; color:#ccc; height:100px; overflow-y:auto; text-align:left; width:100%; border-top:1px solid #eee;">
        </div>
    </div>

    <script>
        // --- Constants ---
        const SERVICE_UUID = "49535343-fe7d-4ae5-8fa9-9fafd205e455";
        const CHAR_WRITE = "49535343-8841-43f4-a8d4-ecbe34729bb3";
        const CHAR_NOTIFY = "49535343-1e4d-4bd9-ba61-23c647249616";

        // Protocol Header
        const HEADER1 = 0xEF;
        const HEADER2 = 0xDD;

        // --- State ---
        let device, server, service, writeChar;
        let heartbeatInterval;

        // --- References ---
        const connectBtn = document.getElementById('connectBtn');
        const weightDisplay = document.getElementById('weightDisplay');
        const timerDisplay = document.getElementById('timerDisplay');
        const statusDiv = document.getElementById('status');
        const logDiv = document.getElementById('log');
        const btns = ['tareBtn', 'timerBtn', 'stopBtn', 'resetBtn'].map(id => document.getElementById(id));

        function log(msg) {
            console.log(msg);
            logDiv.innerText = msg + "\n" + logDiv.innerText.substring(0, 5000);
        }

        // --- Helper: Command Encoding ---
        function encodeCommand(msgType, payload) {
            const data = [HEADER1, HEADER2, msgType, ...payload];
            let cksum1 = 0;
            let cksum2 = 0;

            for (let i = 0; i < payload.length; i++) {
                const val = payload[i] & 0xFF;
                if (i % 2 === 0) cksum1 += val;
                else cksum2 += val;
            }

            data.push(cksum1 & 0xFF);
            data.push(cksum2 & 0xFF);

            return new Uint8Array(data);
        }

        // --- Logic ---

        async function connect() {
            try {
                statusDiv.textContent = "Scanning...";
                log("Starting RequestDevice...");
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: "ACAIA" }, { namePrefix: "PEARL" }, { namePrefix: "LUNAR" }],
                    optionalServices: [SERVICE_UUID]
                });
                log("Device selected: " + device.name);

                device.addEventListener('gattserverdisconnected', onDisconnected);

                statusDiv.textContent = "Connecting...";
                log("Connecting GATT...");
                server = await device.gatt.connect();
                log("GATT Connected.");

                log("Refetching Service...");
                service = await server.getPrimaryService(SERVICE_UUID);
                log("Service Found.");

                // Get Chars
                log("Getting Write Char...");
                writeChar = await service.getCharacteristic(CHAR_WRITE);
                log("Write Char Found.");

                log("Getting Notify Char...");
                const notifyChar = await service.getCharacteristic(CHAR_NOTIFY);
                log("Notify Char Found.");

                // Subscribe
                log("Starting Notifications...");
                await notifyChar.startNotifications();
                notifyChar.addEventListener('characteristicvaluechanged', handleNotification);
                log("Notifications Started.");

                // Handshake
                statusDiv.textContent = "Handshake...";
                log("Initiating Handshake...");
                await sendHandshake();
                log("Handshake Complete.");

                // Heartbeat
                log("Starting Heartbeat Loop...");
                startHeartbeat();

                statusDiv.textContent = "Connected";
                connectBtn.textContent = "Disconnect";
                btns.forEach(b => b.disabled = false);

            } catch (err) {
                console.error(err);
                statusDiv.textContent = "Error: " + err.message;
                log("ERROR: " + err.message);
            }
        }

        async function sendHandshake() {
            // 1. ID (Msg 11) - Old style 0x2D 15 times
            log("HS1: Sending ID...");
            const idPayload = new Array(15).fill(0x2D);
            try {
                await writeChar.writeValueWithoutResponse(encodeCommand(11, idPayload));
                log("HS1: Write OK");
            } catch (e) {
                log("HS1: Write FAILED " + e);
                throw e;
            }

            await new Promise(r => setTimeout(r, 500));

            // 2. Notification Request (Msg 12)
            // Payload: [9, 0, 1, 1, 2, 2, 5, 3, 4]
            log("HS2: Sending Notification Request...");
            const reqPayload = [9, 0, 1, 1, 2, 2, 5, 3, 4];
            try {
                await writeChar.writeValueWithoutResponse(encodeCommand(12, reqPayload));
                log("HS2: Write OK");
            } catch (e) {
                log("HS2: Write FAILED " + e);
                throw e;
            }
        }

        function startHeartbeat() {
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            heartbeatInterval = setInterval(async () => {
                if (device && device.gatt.connected && writeChar) {
                    try {
                        // log("Sending Heartbeat..."); 
                        await writeChar.writeValueWithoutResponse(encodeCommand(0, [2, 0]));
                    } catch (e) { console.warn("HB failed", e); }
                }
            }, 2500);
        }

        function onDisconnected() {
            statusDiv.textContent = "Disconnected";
            connectBtn.textContent = "Connect Scale";
            btns.forEach(b => b.disabled = true);
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            log("Disconnected.");
        }

        // --- Data Parsing ---

        function handleNotification(event) {
            try {
                const value = event.target.value;
                const data = new Uint8Array(value.buffer, value.byteOffset, value.byteLength);

                // Aggressive hex log removed

                for (let i = 0; i < data.length - 1; i++) {
                    if (data[i] === HEADER1 && data[i + 1] === HEADER2) {
                        const cmd = data[i + 2];
                        const len = data[i + 3];

                        // Handle Protocol Wrapper (0x0c)
                        if (cmd === 0x0c) {
                            // Wrapper Payload Logic: [Type] [Payload...] [Type] [Payload...]
                            // The outer `len` bytes cover the entire wrapped content.
                            // Start processing from i + 4
                            let offset = i + 4;
                            const end = offset + len;

                            while (offset < end) {
                                const innerType = data[offset++];

                                if (innerType === 0x05) { // Weight
                                    // Weight payload is 6 bytes
                                    if (offset + 6 <= end + 1) { // Check bounds roughly
                                        const p = data.subarray(offset, offset + 6);
                                        if (p.length === 6) {
                                            const weight = decodeWeight(p);
                                            weightDisplay.textContent = weight.toFixed(1);
                                        }
                                        offset += 6;
                                    } else { break; }
                                } else if (innerType === 0x07) { // Timer
                                    // Timer payload is 3 or 4 bytes: Min, Sec, DS
                                    // Based on logs: 09 05 04 -> 3 bytes seems to be the core data
                                    if (offset + 3 <= end + 1) {
                                        const min = data[offset];
                                        const sec = data[offset + 1];
                                        // const ds = data[offset+2];
                                        timerDisplay.textContent = `${pad(min)}:${pad(sec)}`;
                                        offset += 3; // Timer payload length
                                    } else { break; }
                                } else {
                                    // Unknown type, cannot reliably skip. Abort this packet.
                                    break;
                                }
                            }
                            return;
                        }

                        // Legacy / Standard Single Messages
                        if (cmd === 0x05) { // Weight
                            const payload = data.subarray(i + 3); // legacy structure might differ slightly? assuming standard
                            if (payload.length >= 6) {
                                // For standard msg: data[i+2] is Type, data[i+3] is Len?
                                // Standard: [H1 H2 Type Len Payload...]
                                // My previous code assumed `data[i+2]` was Type.
                                // Let's check `encodeCommand`: `HEADER1, HEADER2, msgType, ...payload`
                                // So `data[i+2]` IS the generic command/type.
                                // And it doesn't have explicit length byte in `encodeCommand`?
                                // `encodeCommand` pushes checksums at end.
                                // So `data[i+3]` is start of payload for standard items?
                                // WAIT. `encodeCommand` implementation: `[H1, H2, msgType, ...payload, ck1, ck2]`
                                // It does NOT insert a length byte for sending.
                                // Receiving might be different.
                                // If I assume standard parsing:

                                const payloadStart = i + 3;
                                const p = data.subarray(payloadStart);
                                const weight = decodeWeight(p);
                                weightDisplay.textContent = weight.toFixed(1);
                            }
                        } else if (cmd === 0x07) { // Timer
                            const payloadStart = i + 3;
                            const p = data.subarray(payloadStart);
                            timerDisplay.textContent = `${pad(p[0])}:${pad(p[1])}`;
                        }
                        return;
                    }
                }
            } catch (e) {
                log("Parse Error: " + e);
            }
        }

        function decodeWeight(payload) {
            const raw = (payload[1] << 8) | payload[0];
            const unit = payload[4];
            let scale = 1.0;
            if (unit === 1) scale = 10.0;
            else if (unit === 2) scale = 100.0;
            else if (unit === 3) scale = 1000.0;
            else if (unit === 4) scale = 10000.0;

            let val = raw / scale;
            if ((payload[5] & 0x02) === 0x02) {
                val *= -1;
            }
            return val;
        }

        function pad(n) { return n < 10 ? '0' + n : n; }

        // --- Controls ---

        connectBtn.onclick = () => {
            if (device && device.gatt.connected) device.gatt.disconnect();
            else connect();
        };

        document.getElementById('tareBtn').onclick = async () => {
            log("Sending TARE...");
            await writeChar.writeValueWithoutResponse(encodeCommand(4, [0]));
        };

        document.getElementById('timerBtn').onclick = async () => {
            log("Sending START...");
            await writeChar.writeValueWithoutResponse(encodeCommand(13, [0, 0]));
        };

        document.getElementById('stopBtn').onclick = async () => {
            log("Sending STOP...");
            await writeChar.writeValueWithoutResponse(encodeCommand(13, [0, 2]));
        };

        document.getElementById('resetBtn').onclick = async () => {
            log("Sending RESET...");
            await writeChar.writeValueWithoutResponse(encodeCommand(13, [0, 1]));
        };

    </script>
</body>

</html>